<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ if .Title }}{{ .Title }}{{ else }}Page Not Found{{ end }}</title>
  <style>
    body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f9f9f9; }
    .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); text-align: center; max-width: 420px; width: 100%; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: #555; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 1rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fallback-link { display: inline-block; margin-top: 1rem; color: #0070f3; text-decoration: none; }
    .fallback-link:hover { text-decoration: underline; }
    .not-found h1 { font-size: 6rem; margin: 0; color: #ddd; }
    .not-found p { color: #666; }
    .not-found a { color: #0070f3; }
  </style>
</head>
<body>
  <div class="card" id="deeplink-ui" style="display:none">
    <div class="spinner"></div>
    <h2>Opening in app…</h2>
    <p id="deeplink-description">If you have the app installed, it should open automatically.</p>
    <a id="fallback-link" class="fallback-link" href="#">Nothing happening? Tap here</a>
  </div>

  <div class="card not-found" id="notfound-ui" style="display:none">
    <h1>404</h1>
    <p>We couldn't find the page you were looking for.</p>
    <a href="/">Go back home</a>
  </div>

  <script>
    const path = window.location.pathname;

    // -----------------------------------------------------------
    // Define your redirect rules here.
    // Each rule has:
    //   match   — a RegExp tested against the path
    //   appUrl  — deep link URI to attempt opening the app
    //   webUrl  — fallback URL if the app isn't installed
    //   label   — human-readable description shown while redirecting
    // -----------------------------------------------------------
    const rules = [
      {
        match: /^\/movie\/(\d+)/,
        appUrl:  (m) => `scenepeek://movie/${m[1]}`,
        webUrl:  (m) => `https://www.themoviedb.org/movie/${m[1]}`,
        label:   "Opening movie in the app",
      },
      {
        match: /^\/tv\/(\d+)/,
        appUrl:  (m) => `scenepeek://tv/${m[1]}`,
        webUrl:  (m) => `https://www.themoviedb.org/tv/${m[1]}`,
        label:   "Opening show in the app",
      },
      // Add more rules here as needed
    ];
    // -----------------------------------------------------------

    const matchedRule = rules.reduce((found, rule) => {
      if (found) return found;
      const m = path.match(rule.match);
      return m ? { rule, m } : null;
    }, null);

    if (matchedRule) {
      const { rule, m } = matchedRule;
      const appUrl  = rule.appUrl(m);
      const webUrl  = rule.webUrl(m);

      // Show deep link UI
      document.getElementById("deeplink-ui").style.display = "block";
      document.getElementById("deeplink-description").textContent = rule.label;

      const fallbackLink = document.getElementById("fallback-link");
      fallbackLink.href = webUrl;

      // Attempt to open the app; redirect to web after timeout
      const timer = setTimeout(() => window.location.replace(webUrl), 1500);
      window.location.href = appUrl;

      document.addEventListener("visibilitychange", () => {
        if (document.hidden) clearTimeout(timer);
      });
    } else {
      // Show normal 404
      document.getElementById("notfound-ui").style.display = "block";
    }
  </script>
</body>
</html>